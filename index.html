<!DOCTYPE html>

<html>

<head>
    <meta charset='UTF-8' />
    <!-- <link href="https://cdn.bootcss.com/Buttons/2.0.0/css/buttons.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />


    <!-- <link href="https://cdn.bootcss.com/Buttons/2.0.0/css/buttons.min.css" rel="stylesheet"> -->
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;

        }


        .leftTeam {
            position: absolute;
            top: 10px;
            left: 0;
            z-index: 99;
        }

        .rightTeam {
            position: absolute;
            top: 10px;
            right: 0;
            z-index: 99;
        }

        .leftPlayers {
            position: absolute;
            /* margin-top: 300px; */
            left: 10px;
            list-style: none;
        }

        .rightPlayers {
            position: absolute;
            right: 10px;
            list-style: none;
        }

        .rightPlayers li,
        .leftPlayers li {
            position: relative;
            width: 180px;
            height: 60px;
            background-color: #86ceea;
            margin-bottom: 3px;
        }

        .rightPlayers li {
            background-color: #ef9393;
        }

        .rightPlayers li img,
        .leftPlayers li img {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            left: 3px;
            top: 50%;
            transform: translateY(-50%);
        }

        .name {
            position: absolute;
            left: 50%;
            top: 30%;
            background-color: blueviolet;
        }

        .hpContainer {
            position: absolute;
            height: 5px;
            width: 100%;
            background-color: white;
            bottom: 3px;
            border-radius: 5px;
        }

        .hpValueDisplay {
            height: 100%;
            width: 50%;
            background-color: rgb(21, 200, 21);
        }



        .battleFieldSituationInfo {
            position: absolute;
            display: flex;
            top: 10px;
            height: 100px;
            width: 300px;
            background-color: #3b75b1;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99;
            align-items: center;
        }

        .blueTeam,
        .redTeam {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 15%;
        }

        .blueTeam {
            background-color: skyblue;

        }

        .redTeam {
            background-color: rgb(216, 45, 45);
        }

        .scoreAndTime {
            display: flex;
            background-color: #cfc8a6;
            height: 80%;
            width: 70%;
        }

        .timeCounter {
            width: 40%;
            font-size: 30px;
            font-weight: 600;
            text-align: center;
            line-height: 80px;
            background-color: #7fafe2;

        }

        .blueTeamSurvivors,
        .redTeamSurvivors {
            width: 30%;
            font-weight: 600;
            font-size: 50px;
            background-color: #fff;
            text-align: center;
            line-height: 80px;
        }

        .tool_bar {
            position: absolute;
            right: 50px;
            top: 20px;
            z-index: 9;
        }

        .leftPlayersIcon {
            border-radius: 50%;
            border: 2px solid blue;
        }

        .rightPlayersIcon {
            border-radius: 50%;
            border: 2px solid rgb(225, 44, 59);
        }

        .leaflet-control-zoom {
            display: none;
        }
    </style>

    <script src="leaflet.js"></script>
    <script src="jquery.js"></script>
    <script src="paho-mqtt.js"></script>
    <script src="mymqtt.js"></script>

    <script>

        window.onload = function () {
            createInnerHTML();

            //************************************************************************           
            //*********************变量***********************************************       
            //************************************************************************  

            centerOfLongitude = 118.923888;  //经度中心点
            centerOfLatitude = 33.404774;   //纬度中心点
            defaultMapLevel = 10;              //默认显示地图层级
            map = L.map('map').setView([centerOfLatitude, centerOfLongitude], defaultMapLevel);      //设置地图
            targetTime = new Date();                        //当前时间
            targetTime.setMinutes(targetTime.getMinutes() + 1); //设置时间

            countDownTimer = undefined;  //倒计时计时器
            setLeftTeamRandomLatLngTimer = undefined;  //加载更新左方队员位置计时器
            setRightTeamRandomLatLngTimer = undefined;  //加载更新左方队员位置计时器

            // 创建 Polyline 图层
            polyline = L.polyline([], { color: 'skyblue' }).addTo(map);
            jsonMarkerList = { "leftTeam": [], "rightTeam": [] }
            jsonPathList = { "leftTeam": [], "rightTeam": [] }
            colorList = [];     //轨迹颜色
            leftPlayerInfoJsonList = [];  //信息

            // (4) [{…}, {…}, {…}, {…}]
            //     0: {id: '0', hp: 50}
            //     1: {id: '1', hp: 100}
            //     2: {id: '2', hp: 100}
            //     3: {id: '3', hp: 100}

            rightPlayerInfoJsonList = []

            //************************************************************************           
            //*********************功能函数*******************************************           
            //************************************************************************           
            // 每秒钟更新倒计时
            countDownTimer = setInterval(updateCountdown, 1000);
            updatePlayersHpDisplay();
            loadMap();                  //加载地图
            loadPlayerPoint(".leftPlayers");      //加载蓝方
            loadPlayerPoint(".rightPlayers");      //加载蓝方
            leftTeamSetRandomLatLng(jsonMarkerList.leftTeam);    //随机位置加载
            jsonMarkerList.leftTeam.forEach(function (res, index) {
                markerPathDisplay(res, index);
            })

            // rightTeamSetRandomLatLng(jsonMarkerList.rightTeam);
            // jsonMarkerList.rightTeam.forEach(function (res, index) {
            //     rightTeamMarkerPathDisplay(res, index);
            // })


            CountPlayersSurvivorsNumber(".leftPlayers", ".blueTeamSurvivors");  //蓝方幸存人数
            CountPlayersSurvivorsNumber(".rightPlayers", ".redTeamSurvivors");//红方幸存人数
            ajaxTest();
            mouseEnterPlayerIconEvent(".leftPlayers");//点击减少50hp
            mouseEnterPlayerIconEvent(".rightPlayers");
            playersIconDoubleClickEvent(".leftPlayers");
            playersIconDoubleClickEvent(".rightPlayers");
            // console.log('leftPlayerInfoJsonList');
            // console.log(leftPlayerInfoJsonList);
        }

        function createInnerHTML(leaftPlayersNum = 5, rightPlayersNum = 5) {


            var leftStr = "";
            var rightStr = "";
            for (var i = 0; i < leaftPlayersNum; i++) {
                leftStr += '<li data-hp="100" data-id=' + (i) + ' data-index=' + (i) + '>';
                leftStr += '    <img src="./icon/' + (i + 1) + '.jpg">';
                leftStr += '    <div class="name">';
                leftStr += '        <a>' + ("name" + parseInt(i + 1)) + '</a>';
                leftStr += '    </div>';
                leftStr += '    <div class="hpContainer">';
                leftStr += '        <div class="hpValueDisplay"></div>';
                leftStr += '    </div>';
                leftStr += '</li>';
            }
            document.querySelector(".leftPlayers").innerHTML = leftStr;
            for (var j = 0; j < rightPlayersNum; j++) {
                rightStr += '<li data-hp="0"" data-id=' + (j + leaftPlayersNum) + ' data-index=' + (j) + '>';
                rightStr += '    <img src="./icon/' + (j + 1 + leaftPlayersNum) + '.jpg">';
                rightStr += '    <div class="name">';
                rightStr += '        <a>' + ("name" + parseInt(j + 1)) + '</a>';
                rightStr += '    </div>';
                rightStr += '    <div class="hpContainer">';
                rightStr += '        <div class="hpValueDisplay"></div>';
                rightStr += '    </div>';
                rightStr += '</li>';
            }
            document.querySelector(".rightPlayers").innerHTML = rightStr;
        }

        function loadMap() {
            //设置id是map的容器宽高 = 浏览器可视区域宽高
            // document.querySelector("#map").style.height = document.documentElement.clientHeight + 'px';
            document.querySelector("#map").style.height = '745px';
            // document.querySelector("#map").style.width = document.documentElement.clientWidth + 'px';
            document.querySelector("#map").style.width = '1519px';
            //利用leaflet显示瓦片地图
            var tileLayer = L.tileLayer('http://localhost:8080/MyMap/newtask/{z}/{x}/{y}.jpg', {
                minZoom: 11,
                maxZoom: 13,
                tileSize: 256, // 瓦片尺寸，通常为256像素
                //zoomOffset: 3, // 瓦片层级的偏移值，用于调整实际层级与显示层级之间的关系
            }).addTo(map);
        };

        function mouseEnterPlayerIconEvent(classNameOrID) {
            var playersList = document.querySelector(classNameOrID).querySelectorAll("li");
            // console.log(playersList);

            playersList.forEach(function (event, index) {
                event.addEventListener("mouseenter", function () {
                    if (classNameOrID.includes("left")) {
                        var playerHp = event.getAttribute('data-hp');
                        if (playerHp - 50 > 0) {
                            playerHp -= 50;
                            leftPlayerInfoJsonList[index].hp -= 50;
                            event.setAttribute('data-hp', playerHp);
                        } else {
                            event.setAttribute('data-hp', 0);
                            leftPlayerInfoJsonList[index].hp = 0;//更新json列表信息
                            event.style.backgroundColor = 'gray';
                        }
                    } else {
                        var playerHp = event.getAttribute('data-hp');
                        if (playerHp - 50 > 0) {
                            playerHp -= 50;
                            rightPlayerInfoJsonList[index].hp -= 50;
                            event.setAttribute('data-hp', playerHp);
                        } else {
                            event.setAttribute('data-hp', 0);
                            rightPlayerInfoJsonList[index].hp = 0;//更新json列表信息
                            event.style.backgroundColor = 'gray';
                        }
                    }

                    updatePlayersHpDisplay();
                    CountPlayersSurvivorsNumber(".leftPlayers", ".blueTeamSurvivors");
                    CountPlayersSurvivorsNumber(".rightPlayers", ".redTeamSurvivors");
                    // console.log(event.getAttribute('data-hp'));
                });
            });
        }
        //更新hp显示
        function updatePlayersHpDisplay() {
            var liList = document.querySelectorAll('li');
            for (let i = 0; i < liList.length; i++) {
                var hpValue = liList[i].getAttribute('data-hp');
                liList[i].querySelector('.hpValueDisplay').style.width = hpValue + "%";
            }
        }
        // 更新倒计时
        function updateCountdown() {
            var currentTime = new Date();
            var timeDifference = targetTime.getTime() - currentTime.getTime();

            // 如果倒计时结束，则显示相应的提示信息
            if (timeDifference <= 0) {
                clearInterval(countDownTimer);
                clearInterval(setLeftTeamRandomLatLngTimer);
                clearInterval(setRightTeamRandomLatLngTimer);
                document.getElementById("countdown").textContent = "00:00";
                // console.log('jsonPathList');
                // console.log(jsonPathList);
                return;
            }
            // 计算剩余的分钟和秒数
            var minutes = Math.floor(timeDifference / (1000 * 60));
            var seconds = Math.floor((timeDifference % (1000 * 60)) / 1000);
            if (seconds < 10) {
                seconds = '0' + seconds;
            }
            if (minutes < 10) {
                minutes = '0' + minutes;
            }
            // 显示倒计时
            document.getElementById("countdown").textContent = minutes + ":" + seconds + "";
        }

        function CountPlayersSurvivorsNumber(classNameOrID, placeWhereChanged) {
            var survivors = 0;
            var liList = document.querySelector(classNameOrID).querySelectorAll("li")
            for (let i = 0; i < liList.length; i++) {
                if (liList[i].getAttribute('data-hp') > 0) {
                    ++survivors;
                }
                else {
                    liList[i].style.backgroundColor = 'gray';
                }
            }
            document.querySelector(placeWhereChanged).textContent = survivors;
        }

        function ajaxTest() {
            var name = "123";
            document.querySelector("#ajaxTest").onclick = function () {

                $.ajax({
                    url: "/test/hello",
                    type: "GET",
                    dataType: "JSON",
                    data: { name: "fku" },
                    success: function (response) {
                        if (response.isSuccess) {
                            console.log(response);
                            var jsonValue = JSON.parse(response.Value);
                            console.log(jsonValue);
                            console.log(response.isSuccess);
                            for (let j = 0; j < jsonValue.length; j++) {
                                console.log(jsonValue[j].name);
                            }
                        }
                        else {
                            alert("wrong");
                        }
                    },
                })
            }
        }
        //随机数，测试用
        function randomNum(min, max) {
            var randomNum = Math.random() * (max - min) + min
            return parseFloat(randomNum.toFixed(6));
        }

        function randomColor() {
            var palette = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += palette[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function getColor(num) {
            for (let i = 0; i < num; i++) {
                colorList.push(randomColor());
            }
        }

        function loadPlayerPoint(classNameOrID) {
            var Ul = document.querySelector(classNameOrID);
            var liList = Ul.querySelectorAll("li");
            getColor(liList.length);
            if (classNameOrID.includes("left")) {
                for (let i = 0; i < liList.length; i++) {
                    var pathTemp = [];
                    var Icon = L.icon({
                        iconUrl: liList[i].querySelector('img').getAttribute('src'),
                        iconSize: [20],
                        className: classNameOrID.substring(1) + "Icon playersIcon"         //为自定义标记点图标添加类名
                    })
                    var lat = randomNum(33.464671, 33.664671);
                    var lng = randomNum(118.859960, 118.959960);
                    var latlngPoint = L.latLng(lat, lng);
                    var marker = L.marker(latlngPoint, { icon: Icon }).addTo(map);//标记点
                    var jsonValue = { "id": liList[i].getAttribute('data-id'), "hp": parseInt(liList[i].getAttribute('data-hp')) };
                    leftPlayerInfoJsonList.push(jsonValue);//初始化json信息列表
                    pathTemp.push([lat, lng]);
                    jsonPathList.leftTeam.push(pathTemp);
                    jsonMarkerList.leftTeam.push(marker);
                }
            } else {
                for (let i = 0; i < liList.length; i++) {
                    var pathTemp = [];
                    var Icon = L.icon({
                        iconUrl: liList[i].querySelector('img').getAttribute('src'),
                        iconSize: [20],
                        className: classNameOrID.substring(1) + "Icon playersIcon"         //为自定义标记点图标添加类名
                    })
                    var lat = randomNum(33.464671, 33.664671);
                    var lng = randomNum(118.859960, 118.959960);
                    var latlngPoint = L.latLng(lat, lng);
                    var marker = L.marker(latlngPoint, { icon: Icon }).addTo(map);//标记点
                    var jsonValue = { "id": liList[i].getAttribute('data-id'), "hp": parseInt(liList[i].getAttribute('data-hp')) };
                    rightPlayerInfoJsonList.push(jsonValue);//初始化json信息列表
                    pathTemp.push([lat, lng]);
                    jsonPathList.rightTeam.push(pathTemp);
                    jsonMarkerList.rightTeam.push(marker);
                }
            }

        }
        //显示左锚点运动轨迹
        function markerPathDisplay(marker, index) {
            marker.on('move', function (marker) { // 监听点位移动事件 move
                L.polyline(jsonPathList.leftTeam[index], { color: colorList[index], weight: 2 }).addTo(map) // 绘制线到地图图层
            })
        }

        function leftTeamSetRandomLatLng(markerList) {
            var leftLiList = document.querySelector(".leftPlayers").querySelectorAll("li");

            setLeftTeamRandomLatLngTimer = setInterval(function () {

                for (let i = 0; i < 5; i++) {
                    var dataReceivedFromServer = sendDate();//接收模拟的后台传来的数据
                    console.log("函数返回index");
                    console.log(dataReceivedFromServer.id);
                    console.log("函数返回坐标");
                    console.log(dataReceivedFromServer.coord);

                    leftLiList.forEach(function (res) {
                        var id = res.getAttribute("data-id");
                        if (id == dataReceivedFromServer.id) {
                            var index = res.getAttribute("data-index");//获取对应id的index位置值
                            markerMove(markerList[index], index, dataReceivedFromServer);
                        }
                    })
                }
                // markerList.forEach(function (res, index) {

                //     markerMove(res, index);
                //     // markerPathDisplay(res, index); //路径绘制函数放这里将抛弃初始点，只绘制更新的点
                // })
            }, 5000)

        }
        //左队锚点随机运动
        function markerMove(marker, index = 0, dataReceivedFromServer) {
            var gps = dataReceivedFromServer.coord.split('|');
            var lat = parseFloat(gps[0]);
            var lng = parseFloat(gps[1]);
            // var lat = randomNum(33.464671, 33.664671);
            // var lng = randomNum(118.859960, 118.959960);
            if (leftPlayerInfoJsonList[index].hp > 0) {
                console.log("左队所有坐标");
                console.log(jsonPathList.leftTeam);
                jsonPathList.leftTeam[index].length > 1 && jsonPathList.leftTeam[index].shift() // 保持数组长度，避免过度push不断重新绘制之前的路径
                var pathTemp = jsonPathList.leftTeam[index];
                pathTemp.push([lat, lng]);
                jsonPathList.leftTeam[index] = pathTemp;
                var newLatlngPoint = L.latLng(lat, lng);
                leftPlayerInfoJsonList[index].hp > 0 && marker.setLatLng(newLatlngPoint);
            }
        }
        //显示右锚点运动轨迹
        function rightTeamMarkerPathDisplay(marker, index) {
            marker.on('move', function (marker) { // 监听点位移动事件 move
                L.polyline(jsonPathList.rightTeam[index], { color: colorList[index], weight: 2 }).addTo(map) // 绘制线到地图图层
            })
        }
        //设置更新右队锚点
        function rightTeamSetRandomLatLng(markerList) {
            setRightTeamRandomLatLngTimer = setInterval(function () {
                markerList.forEach(function (res, index) {
                    rightMarkerMove(res, index);
                    // rightTeamMarkerPathDisplay(res, index); //路径绘制函数放这里将抛弃初始点，只绘制更新的点
                })
            }, 5000)

        }
        //右队锚点随机运动
        function rightMarkerMove(marker, index = 0) {
            var lat = randomNum(33.464671, 33.664671);
            var lng = randomNum(118.859960, 118.959960);
            if (rightPlayerInfoJsonList[index].hp > 0) {
                jsonPathList.rightTeam[index].length > 1 && jsonPathList.rightTeam[index].shift() // 保持数组长度，避免过度push不断重新绘制之前的路径
                var pathTemp = jsonPathList.rightTeam[index];
                pathTemp.push([lat, lng]);
                jsonPathList.rightTeam[index] = pathTemp;
                var newLatlngPoint = L.latLng(lat, lng);
                rightPlayerInfoJsonList[index].hp > 0 && marker.setLatLng(newLatlngPoint);
            }
        }

        //双击头像恢复HP
        function playersIconDoubleClickEvent(team) {
            var liList = document.querySelector(team).querySelectorAll("li");
            liList.forEach(function (res, index) {
                res.querySelector("img").addEventListener("dblclick", function () {
                    res.setAttribute("data-hp", 100);

                    if (res.parentNode.getAttribute("class").includes("left")) {
                        res.style.backgroundColor = "#86ceea";
                        leftPlayerInfoJsonList[index].hp = 100;
                    }
                    else {
                        res.style.backgroundColor = "#ef9393";
                        rightPlayerInfoJsonList[index].hp = 100;

                    }
                    updatePlayersHpDisplay();
                    CountPlayersSurvivorsNumber(".leftPlayers", ".blueTeamSurvivors");
                    CountPlayersSurvivorsNumber(".rightPlayers", ".redTeamSurvivors");

                })
            })
        }

        //随机数，不包含max
        function randomIntNum(min, max) {
            var randomNum = Math.random() * (max - min) + min;
            return parseInt(randomNum);
        }
        function randomGPS(min, max) {
            var randomNum = Math.random() * (max - min) + min;
            return parseFloat(randomNum.toFixed(6));
        }
        //模拟发送的数据
        function sendDate() {
            var date = [
                { "id": "0", "coord": "113.123|24.369", "msg": 0 },
                { "id": "1", "coord": "112.123|24.369", "msg": 0 },
                { "id": "2", "coord": "111.123|24.369", "msg": 0 },
                { "id": "3", "coord": "113.123|24.369", "msg": 0 },
                { "id": "4", "coord": "113.123|24.369", "msg": 0 },
            ];

            var lat = randomGPS(33.464671, 33.664671);
            var lng = randomGPS(118.859960, 118.959960);
            var index = randomIntNum(0, 5)
            date[index].coord = lat + '|' + lng;
            return date[index]
        }

    </script>

    <title>Gaoded statellite Map</title>
</head>

<body>
    <div class="leftTeam">
        <button id="ajaxTest">test</button>

        <ul class="leftPlayers">

        </ul>
    </div>

    <div class="rightTeam">
        <ul class="rightPlayers">
        </ul>
    </div>

    <div class="battleFieldSituationInfo">

        <div class="blueTeam">
            <h3 style="writing-mode: vertical-lr;">蓝方</h3>
        </div>

        <div class="scoreAndTime">
            <div class="blueTeamSurvivors">4</div>
            <p class="timeCounter" id="countdown"></p>
            <div class="redTeamSurvivors">2</div>
        </div>
        <div class="redTeam">
            <h3 style="writing-mode: vertical-lr;">红方</h3>
        </div>

    </div>

    <div id='map'></div>



</body>

</html>