<!DOCTYPE html>

<html>

<head>
    <meta charset='UTF-8' />
    <!-- <link href="https://cdn.bootcss.com/Buttons/2.0.0/css/buttons.min.css" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />


    <!-- <link href="https://cdn.bootcss.com/Buttons/2.0.0/css/buttons.min.css" rel="stylesheet"> -->
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            z-index: 1;

        }


        .leftTeam {
            position: absolute;
            top: 10px;
            left: 0;
            z-index: 99;
        }

        .rightTeam {
            position: absolute;
            top: 10px;
            right: 0;
            z-index: 99;
        }

        .leftPlayers {
            position: absolute;
            /* margin-top: 300px; */
            left: 10px;
            list-style: none;
        }

        .rightPlayers {
            position: absolute;
            right: 10px;
            list-style: none;
        }

        .rightPlayers li,
        .leftPlayers li {
            position: relative;
            width: 180px;
            height: 60px;
            background-color: #86ceea;
            margin-bottom: 3px;
        }

        .rightPlayers li {
            background-color: #ef9393;
        }

        .rightPlayers li img,
        .leftPlayers li img {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            left: 3px;
            top: 50%;
            transform: translateY(-50%);
        }

        .name {
            position: absolute;
            left: 50%;
            top: 30%;
            background-color: blueviolet;
        }

        .hpContainer {
            position: absolute;
            height: 5px;
            width: 100%;
            background-color: white;
            bottom: 3px;
            border-radius: 5px;
        }

        .hpValueDisplay {
            height: 100%;
            width: 50%;
            background-color: rgb(21, 200, 21);
        }



        .battleFieldSituationInfo {
            position: absolute;
            display: flex;
            top: 10px;
            height: 100px;
            width: 300px;
            background-color: #3b75b1;
            left: 50%;
            transform: translateX(-50%);
            z-index: 99;
            align-items: center;
        }

        .blueTeam,
        .redTeam {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 15%;
        }

        .blueTeam {
            background-color: skyblue;

        }

        .redTeam {
            background-color: rgb(216, 45, 45);
        }

        .scoreAndTime {
            display: flex;
            background-color: #cfc8a6;
            height: 80%;
            width: 70%;
        }

        .timeCounter {
            width: 40%;
            font-size: 30px;
            font-weight: 600;
            text-align: center;
            line-height: 80px;
            background-color: #7fafe2;

        }

        .blueTeamSurvivors,
        .redTeamSurvivors {
            width: 30%;
            font-weight: 600;
            font-size: 50px;
            background-color: #fff;
            text-align: center;
            line-height: 80px;
        }

        .tool_bar {
            position: absolute;
            right: 50px;
            top: 20px;
            z-index: 9;
        }

        .leftPlayersIcon {
            border-radius: 50%;
            border: 2px solid blue;
        }

        .rightPlayersIcon {
            border-radius: 50%;
            border: 2px solid rgb(225, 44, 59);
        }

        .leaflet-control-zoom {
            display: none;
        }

        /* 模态框 */
        .mask {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 100;
            display: none;
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 400px;
            transform: translate(-50%, -50%);
            border-radius: 5px;
            background: #fff;
            box-shadow: 2px 3px 20px rgba(0, 0, 0, 0.2);
            z-index: 120;
            display: none;
        }

        .modal .modal-header {
            height: 50px;
            border-bottom: 1px solid #f5f5f5;
            padding: 0 15px;
        }

        .modal .modal-header p {
            line-height: 50px;
            display: inline-block;
        }

        .modal .modal-header .title {
            font-size: 18px;
            color: #333;
        }

        .modal .modal-header .close {
            float: right;
            font-size: 26px;
            margin-top: -2px;
            color: #9C9FA4;
            cursor: default;
        }

        .modal .modal-content {
            min-height: 100px;
        }

        .modal .modal-footer .btn {
            padding: 0 20px;
            height: 36px;
            line-height: 36px;
            color: white;
            background: #409EFF;
            border: none;
        }

        .modal .modal-footer {
            border-top: 1px solid #f5f5f5;
            padding: 15px;
            text-align: right;

        }

        .container::after {
            content: "";
            display: block;
            clear: both;
        }
    </style>

    <script src="leaflet.js"></script>
    <script src="jquery.js"></script>
    <script src="paho-mqtt.js"></script>
    <script src="mymqtt.js"></script>

    <script>

        window.onload = function () {
            createInnerHTML(4);
            var liList = document.querySelectorAll('li')
            var IDList = []
            liList.forEach(function (res) {
                IDList.push(res.getAttribute("data-id"));
            })
            console.log(IDList);
            sendAjaxs(IDList);
            //************************************************************************           
            //*********************变量***********************************************       
            //************************************************************************  
            webSocket = new WebSocket('ws://localhost:8080/savePathToFile/websocket');

            centerOfLongitude = 118.923888;  //经度中心点
            centerOfLatitude = 33.404774;   //纬度中心点
            defaultMapLevel = 10;              //默认显示地图层级
            map = L.map('map').setView([centerOfLatitude, centerOfLongitude], defaultMapLevel);      //设置地图
            targetTime = new Date();                        //当前时间
            gameMinutes = 1
            // getGameTime();
            targetTime.setMinutes(targetTime.getMinutes() + gameMinutes); //设置时间

            countDownTimer = undefined;  //倒计时计时器
            setLeftTeamRandomLatLngTimer = undefined;  //加载更新左方队员位置计时器
            setRightTeamRandomLatLngTimer = undefined;  //加载更新左方队员位置计时器

            // 创建 Polyline 图层
            polyline = L.polyline([], { color: 'skyblue' }).addTo(map);
            jsonMarkerList = { "leftTeam": [], "rightTeam": [] }
            jsonPathList = { "leftTeam": [], "rightTeam": [] }
            colorList = [];     //轨迹颜色
            leftPlayerInfoJsonList = [];  //信息

            // (4) [{…}, {…}, {…}, {…}]
            //     0: {id: '0', hp: 50}
            //     1: {id: '1', hp: 100}
            //     2: {id: '2', hp: 100}
            //     3: {id: '3', hp: 100}

            rightPlayerInfoJsonList = []

            //************************************************************************           
            //*********************功能函数*******************************************           
            //************************************************************************           
            // 每秒钟更新倒计时
            countDownTimer = setInterval(updateCountdown, 1000);
            updatePlayersHpDisplay();
            loadMap();                  //加载地图
            loadPlayerPoint(".leftPlayers");      //加载蓝方
            loadPlayerPoint(".rightPlayers");      //加载蓝方

            testTimer = setInterval(function () {
                var data = sendDate();
                console.log(data);
                leftTeamSetRandomLatLng(jsonMarkerList.leftTeam, data);    //随机位置加载
                rightTeamSetRandomLatLng(jsonMarkerList.rightTeam, data);
            }, 10000)

            // jsonMarkerList.leftTeam.forEach(function (res, index) {
            //     markerPathDisplay(res, index);
            // })

            // jsonMarkerList.rightTeam.forEach(function (res, index) {
            //     rightTeamMarkerPathDisplay(res, index);
            // })

            CountPlayersSurvivorsNumber(".leftPlayers", ".blueTeamSurvivors");  //蓝方幸存人数
            CountPlayersSurvivorsNumber(".rightPlayers", ".redTeamSurvivors");//红方幸存人数
            ajaxTest();
            mouseEnterPlayerIconEvent(".leftPlayers");//点击减少50hp
            mouseEnterPlayerIconEvent(".rightPlayers");
            playersIconDoubleClickEvent(".leftPlayers");
            playersIconDoubleClickEvent(".rightPlayers");
            console.log('leftPlayerInfoJsonList');
            console.log(leftPlayerInfoJsonList);

            container = document.getElementsByClassName("container")[0];
            mask = document.getElementsByClassName("mask")[0];
            modal = document.getElementsByClassName("modal")[0];
            closes = document.getElementsByClassName("close");
            confirmBtn = document.querySelector('#confirmBtn')
            confirmBtn.onclick = confirmBtnEvent;
            closes[0].onclick = closeModal;
            closes[1].onclick = closeModal;
            webSocket.onerror = function (event) {
                onError(event)
            };

            webSocket.onopen = function (event) {
                onOpen(event)
            };

            webSocket.onmessage = function (event) {
                onMessage(event)
            };
        }
        {
            var client = null;					//成功连接后的客户端对象
            var cnn_options = {					//连接MQTT的参数
                "ServerUri": "127.0.0.1",
                "ServerPort": 9001,
                "UserName": "admin",				//服务器登录用户名
                "PassWord": "123456",			//密码
                "ClientId": "webSocket" + Math.random().toString(16).substr(2, 8), //客户端ID
                "Path": "/mqtt",
                "TimeOut": 30000,
                "KeepAlive": 60000,//心跳保活时长
                "CleanSession": false,//是否清理session
                "SSL": false,//是否启用SSL安全
                "willMessage": {
                    "topic": "",
                    "payload": "",
                    "qos": 0,
                    "retain": 0
                },
                //"ReConnect":false
            }

            //外部继承接口事件函数
            var mqttstatus = false;
            var startSubscribeTeam = false;//是否开始订阅队员状态

            function OnConnectExtern() {//连接成功
                //alert("连接成功");
                mqttstatus = true;
                console.log('连接成功');
                if (startSubscribeTeam) {
                    console.log("开始订阅");

                    mqtt_subscribe("status");//订阅状态coord

                    console.log("开始发布");
                    //连接成功第一件事就是发送获取成员状态的指令
                    mqtt_pulish("order", "status:Publish Test");//order ,"coord"   ,order ,"stop"
                    console.log("发布成功");
                };
            }

            function OnConnFailureExtern() {//连接服务器失败
                mqttstatus = false;
            }

            function OnConnLostExtern() {//与服务器失去连接
                mqttstatus = false;
            }

            function OnMsgSendOverExtern() {//消息发送成功

            }

            function OnMsgRecvExtern(topic, payload) {//处理接收消息
                console.log("接收到消息");
                if (!startSubscribeTeam)//如果没有订阅成员状态
                    return;

                if (topic.indexOf("status") != -1) {
                    //payload 指定成员的状态
                    console.log(payload);//打印消息
                    // var payload=JSON.parse(payload.slice(payload.indexOf(":")+1));  看情况添加
                    // leftTeamSetRandomLatLng(jsonMarkerList.leftTeam, payload);    //随机位置加载
                    // rightTeamSetRandomLatLng(jsonMarkerList.rightTeam, payload);

                    //coord =topic

                }
                //取下一个标识号的状态
                //mqtt_pulish("order" ,"status:23456");
            };


            /////////////////////////////
            //开始状态检查，开启MQTT
            function StartCheck() {
                //置开始检查标识
                startSubscribeTeam = true;

                if (!mqttstatus) {
                    //连接MQTT
                    //alert("连接MQTT");
                    cnn_options.ClientId = "Rxiry_CS";
                    cnn_options.ServerPort = 8083;
                    cnn_options.ServerUri = "192.168.8.102";
                    MQTTconnect();
                    //alert("已经发送连接MQTT");		
                } else {//先订阅，然后再发布开始消息
                    mqtt_subscribe("status");//用于获取成员状态

                    //先订阅第一个成员状态
                    mqtt_pulish("order", "status:coord");
                }

            }
        }
        //////////////////////////////////////////////////////////////////////////////////
        //////////////////////////////////////////////////////////////////////////////////
        function closeModal() {
            mask.style.display = "none";
            modal.style.display = "none";
        }
        function show(ID) {
            mask.style.display = "block";
            modal.style.display = "block";
            document.querySelector("#confirmBtn").setAttribute("data-value", ID);
            document.querySelector('#modal-content').innerHTML = '  确认恢复ID为' + ID + "的用户HP？";
        }
        function confirmBtnEvent() {
            var ID = document.querySelector("#confirmBtn").getAttribute("data-value");
            ResetPlayerStatus(ID);
            updatePlayersHpDisplay();
            CountPlayersSurvivorsNumber(".leftPlayers", ".blueTeamSurvivors");
            CountPlayersSurvivorsNumber(".rightPlayers", ".redTeamSurvivors");


            mask.style.display = "none";
            modal.style.display = "none";
        }

        function test() {
            var dataReceivedFromServer = {//接受到的人员数据
                "icode": "", "msg": "GETMEN",
                "data": "id_Flag=121234|name_attrib=红队;id_Flag=87654|name_attrib=红队;id_Flag=334455|name_attrib=红队;id_Flag=34563456|name_attrib=红队;id_Flag=234532456|name_attrib=蓝队;"
            }
            var data = dataReceivedFromServer.data;
            data = data.split(";");
            for (let i = 0; i < data.length; i++) {
                data[i].length < 1 && data.splice(i)
                if (data[i]) {
                    var json = {}
                    var str = data[i].split("|")
                    str.forEach(res => {
                        var tempList = [];
                        temp = res.split("=");
                        json[temp[0]] = temp[1];
                    })
                    data[i] = json;
                }
            }
            IDList = []//初始化获得所有ID，用于测试保存的路径是否正确
            bluePlayersIDList = [], redPlayersIDList = [];//用于存储ID
            data.forEach(res => {//分队伍存储人员ID
                IDList.push(res.id_Flag);

                res.name_attrib == "蓝队" && bluePlayersIDList.push(res.id_Flag);
                res.name_attrib == "红队" && redPlayersIDList.push(res.id_Flag);
            })

        }
        //修改creatInnerHTML（）
        function createInnerHTML() {
            IDAndPathJsonList = []        //存储ID和对应经过的路径点

            test();
            // GETMENCommand();
            for (let i = 0; i < IDList.length; i++) {
                var jsonList = { "id": "", "path": [] };
                jsonList.id = IDList[i];
                IDAndPathJsonList.push(jsonList);
            }

            var leftStr = "";
            var rightStr = "";
            for (var i = 0; i < bluePlayersIDList.length; i++) {
                leftStr += '<li data-hp="100" data-id=' + (bluePlayersIDList[i]) + ' data-index=' + (i) + ' data-hit_state=" "' + ' data-NumberOfRevive="0"' + ' data-DamageDescription=" "' + '>';
                leftStr += '    <img src="./icon/' + (i + 1) + '.jpg">';
                leftStr += '    <div class="name">';
                leftStr += '        <a>' + ("ID" + bluePlayersIDList[i]) + '</a>';
                leftStr += '    </div>';
                leftStr += '    <div class="hpContainer">';
                leftStr += '        <div class="hpValueDisplay"></div>';
                leftStr += '    </div>';
                leftStr += '</li>';
            }
            document.querySelector(".leftPlayers").innerHTML = leftStr;
            for (var j = 0; j < redPlayersIDList.length; j++) {
                rightStr += '<li data-hp="100" data-id=' + (redPlayersIDList[j]) + ' data-index=' + (j) + ' data-hit_state=" "' + ' data-NumberOfRevive="0"' + ' data-DamageDescription=" "' + '>';
                rightStr += '    <img src="./icon/' + (j + 1 + bluePlayersIDList.length) + '.jpg">';
                rightStr += '    <div class="name">';
                rightStr += '        <a>' + ("ID" + redPlayersIDList[j]) + '</a>';
                rightStr += '    </div>';
                rightStr += '    <div class="hpContainer">';
                rightStr += '        <div class="hpValueDisplay"></div>';
                rightStr += '    </div>';
                rightStr += '</li>';
            }
            document.querySelector(".rightPlayers").innerHTML = rightStr;
        }
        // function createInnerHTML(leaftPlayersNum = 5, rightPlayersNum = 5) {
        //     var leftStr = "";
        //     var rightStr = "";
        //     for (var i = 0; i < leaftPlayersNum; i++) {
        //         leftStr += '<li data-hp="100" data-id=' + (i) + ' data-index=' + (i) + '>';
        //         leftStr += '    <img src="./icon/' + (i + 1) + '.jpg">';
        //         leftStr += '    <div class="name">';
        //         leftStr += '        <a>' + ("name" + parseInt(i)) + '</a>';
        //         leftStr += '    </div>';
        //         leftStr += '    <div class="hpContainer">';
        //         leftStr += '        <div class="hpValueDisplay"></div>';
        //         leftStr += '    </div>';
        //         leftStr += '</li>';
        //     }
        //     document.querySelector(".leftPlayers").innerHTML = leftStr;
        //     for (var j = 0; j < rightPlayersNum; j++) {
        //         rightStr += '<li data-hp="100"" data-id=' + (j + leaftPlayersNum) + ' data-index=' + (j) + '>';
        //         rightStr += '    <img src="./icon/' + (j + 1 + leaftPlayersNum) + '.jpg">';
        //         rightStr += '    <div class="name">';
        //         rightStr += '        <a>' + ("name" + parseInt(j + leaftPlayersNum)) + '</a>';
        //         rightStr += '    </div>';
        //         rightStr += '    <div class="hpContainer">';
        //         rightStr += '        <div class="hpValueDisplay"></div>';
        //         rightStr += '    </div>';
        //         rightStr += '</li>';
        //     }
        //     document.querySelector(".rightPlayers").innerHTML = rightStr;
        // }
        function loadMap() {
            //设置id是map的容器宽高 = 浏览器可视区域宽高
            // document.querySelector("#map").style.height = document.documentElement.clientHeight + 'px';
            document.querySelector("#map").style.height = '745px';
            // document.querySelector("#map").style.width = document.documentElement.clientWidth + 'px';
            document.querySelector("#map").style.width = '1519px';
            //利用leaflet显示瓦片地图
            var tileLayer = L.tileLayer('http://localhost:8080/MyMap/newtask/{z}/{x}/{y}.jpg', {
                minZoom: 10,
                maxZoom: 13,
                tileSize: 256, // 瓦片尺寸，通常为256像素
                //zoomOffset: 3, // 瓦片层级的偏移值，用于调整实际层级与显示层级之间的关系
            }).addTo(map);
            // var center = map.getCenter();
            // console.log(center); // 输出中心点的经纬度

        };

        function mouseEnterPlayerIconEvent(classNameOrID) {
            var playersList = document.querySelector(classNameOrID).querySelectorAll("li");
            // console.log(playersList);
            var SubtractedHPValue = 30
            playersList.forEach(function (event, index) {
                event.addEventListener("mouseenter", function () {
                    var playerHp = event.getAttribute('data-hp');
                    if (classNameOrID.includes("left")) {
                        if (playerHp - SubtractedHPValue > 0) {
                            playerHp -= SubtractedHPValue;
                            leftPlayerInfoJsonList[index].hp -= SubtractedHPValue;
                            event.setAttribute('data-hp', playerHp);
                        } else {
                            event.setAttribute('data-hp', 0);
                            leftPlayerInfoJsonList[index].hp = 0;//更新json列表信息
                            event.style.backgroundColor = 'gray';
                        }
                    }
                    else {
                        if (playerHp - SubtractedHPValue > 0) {
                            playerHp -= SubtractedHPValue;
                            rightPlayerInfoJsonList[index].hp -= SubtractedHPValue;
                            event.setAttribute('data-hp', playerHp);
                        } else {
                            event.setAttribute('data-hp', 0);
                            rightPlayerInfoJsonList[index].hp = 0;//更新json列表信息
                            event.style.backgroundColor = 'gray';
                        }
                    }

                    updatePlayersHpDisplay();
                    CountPlayersSurvivorsNumber(".leftPlayers", ".blueTeamSurvivors");
                    CountPlayersSurvivorsNumber(".rightPlayers", ".redTeamSurvivors");
                    // console.log(event.getAttribute('data-hp'));
                    var playerID = event.getAttribute('data-id');

                    $.ajax({
                        url: "http://localhost:8090/servlet/ShootData",
                        type: "GET",
                        data: {
                            funTypeName: "UPDAMAGE",
                            id_Flag: playerID,
                            subblood: SubtractedHPValue,
                            describe: event.getAttribute('data-damagedescription')
                        },
                        dataType: "JSON",
                        success: function (res) {
                            if (res == "ok") {
                                console.log("UPDAMAGE: " + playerID);
                            }
                        },
                        error: function () {
                            console.log(playerID + "UPDAMAGE错误");
                        }
                    });
                });
            });
        }
        //更新hp显示
        function updatePlayersHpDisplay() {
            var liList = document.querySelectorAll('li');
            for (let i = 0; i < liList.length; i++) {
                var hpValue = liList[i].getAttribute('data-hp');
                liList[i].querySelector('.hpValueDisplay').style.width = hpValue + "%";
            }
        }
        // 更新倒计时
        function updateCountdown() {
            var currentTime = new Date();
            var timeDifference = targetTime.getTime() - currentTime.getTime();

            // 如果倒计时结束，则显示相应的提示信息
            if (timeDifference <= 0) {
                clearInterval(countDownTimer);
                clearInterval(setLeftTeamRandomLatLngTimer);
                clearInterval(setRightTeamRandomLatLngTimer);
                clearInterval(testTimer);
                webSocket.close()
                document.getElementById("countdown").textContent = "00:00";
                console.log('jsonPathList');
                console.log(jsonPathList);
                return;
            }
            // 计算剩余的分钟和秒数
            var minutes = Math.floor(timeDifference / (1000 * 60));
            var seconds = Math.floor((timeDifference % (1000 * 60)) / 1000);
            if (seconds < 10) {
                seconds = '0' + seconds;
            }
            if (minutes < 10) {
                minutes = '0' + minutes;
            }
            // 显示倒计时
            document.getElementById("countdown").textContent = minutes + ":" + seconds + "";
        }

        function CountPlayersSurvivorsNumber(classNameOrID, placeWhereChanged) {
            var survivors = 0;
            var liList = document.querySelector(classNameOrID).querySelectorAll("li")
            for (let i = 0; i < liList.length; i++) {
                if (liList[i].getAttribute('data-hp') > 0) {
                    ++survivors;
                }
                else {
                    liList[i].style.backgroundColor = 'gray';
                }
            }
            document.querySelector(placeWhereChanged).textContent = survivors;
        }

        function ajaxTest() {
            var name = "123";
            document.querySelector("#ajaxTest").onclick = function () {

                $.ajax({
                    url: "/test/hello",
                    type: "GET",
                    dataType: "JSON",
                    data: { name: "ku" },
                    success: function (response) {
                        if (response.isSuccess) {
                            console.log(response);
                            var jsonValue = JSON.parse(response.Value);
                            console.log(jsonValue);
                            console.log(response.isSuccess);
                            for (let j = 0; j < jsonValue.length; j++) {
                                console.log(jsonValue[j].name);
                            }
                        }
                        else {
                            alert("wrong");
                        }
                    },
                })
            }
        }
        //随机数，测试用
        function randomNum(min, max) {
            var randomNum = Math.random() * (max - min) + min
            return parseFloat(randomNum.toFixed(6));
        }

        function randomColor() {
            var palette = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
                color += palette[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        function getColor(num) {
            for (let i = 0; i < num; i++) {
                colorList.push(randomColor());
            }
        }

        function loadPlayerPoint(classNameOrID) {
            var Ul = document.querySelector(classNameOrID);
            var liList = Ul.querySelectorAll("li");
            getColor(liList.length);
            var center = map.getCenter();
            var lat = center.lat;
            var lng = center.lng;
            if (classNameOrID.includes("left")) {
                for (let i = 0; i < liList.length; i++) {
                    var pathTemp = [];
                    var Icon = L.icon({
                        iconUrl: liList[i].querySelector('img').getAttribute('src'),
                        iconSize: [20],
                        className: classNameOrID.substring(1) + "Icon playersIcon"         //为自定义标记点图标添加类名
                    })
                    // var lat = randomNum(33.464671, 33.664671);
                    // var lng = randomNum(118.859960, 118.959960);

                    // var lat = 33.464671;
                    // var lng = 118.859960;
                    var latlngPoint = L.latLng(lat, lng);
                    var marker = L.marker(latlngPoint, { icon: Icon }).addTo(map);//标记点
                    var jsonValue = { "id": liList[i].getAttribute('data-id'), "hp": parseInt(liList[i].getAttribute('data-hp')) };
                    leftPlayerInfoJsonList.push(jsonValue);//初始化json信息列表
                    pathTemp.push([]);
                    jsonPathList.leftTeam.push(pathTemp);
                    jsonMarkerList.leftTeam.push(marker);
                }
            } else {
                for (let i = 0; i < liList.length; i++) {
                    var pathTemp = [];
                    var Icon = L.icon({
                        iconUrl: liList[i].querySelector('img').getAttribute('src'),
                        iconSize: [20],
                        className: classNameOrID.substring(1) + "Icon playersIcon"         //为自定义标记点图标添加类名
                    })
                    // var lat = randomNum(33.464671, 33.664671);
                    // var lng = randomNum(118.859960, 118.959960);
                    // var lat = 33.464671;
                    // var lng = 118.859960;
                    var latlngPoint = L.latLng(lat, lng);
                    var marker = L.marker(latlngPoint, { icon: Icon }).addTo(map);//标记点
                    var jsonValue = { "id": liList[i].getAttribute('data-id'), "hp": parseInt(liList[i].getAttribute('data-hp')) };
                    rightPlayerInfoJsonList.push(jsonValue);//初始化json信息列表
                    pathTemp.push([]);
                    jsonPathList.rightTeam.push(pathTemp);
                    jsonMarkerList.rightTeam.push(marker);
                }
            }

        }
        //显示左锚点运动轨迹
        function markerPathDisplay(marker, index) {
            marker.on('move', function (marker) { // 监听点位移动事件 move
                L.polyline(jsonPathList.leftTeam[index], { color: colorList[index], weight: 2 }).addTo(map) // 绘制线到地图图层
            })
        }

        function leftTeamSetRandomLatLng(markerList, dataReceived) {
            var leftLiList = document.querySelector(".leftPlayers").querySelectorAll("li");
            //array.slice(start, end) 截取字符串
            // var dataReceivedFromServer = JSON.parse(dataReceived);//接收后台传来的数据  假设传过来的直接是json字符串
            // var dataReceivedFromServer = dataReceived;
            for (let i = 0; i < dataReceived.length; i++) {
                leftLiList.forEach(function (res) {
                    var id = res.getAttribute("data-id");
                    if (id == dataReceived[i].id) {
                        var index = res.getAttribute("data-index");//获取对应id的index位置值
                        markerMove(markerList[index], index, dataReceived[i]);
                        // markerPathDisplay(res, index); //路径绘制函数放这里将抛弃初始点，只绘制更新的点
                        // markerPathDisplay(markerList[index], index);
                    }
                })
            }
        }
        //左队锚点随机运动
        function markerMove(marker, index = 0, dataReceivedFromServer) {
            var gps = dataReceivedFromServer.coord.split('|');
            var lat = parseFloat(gps[0]);
            var lng = parseFloat(gps[1]);
            if (leftPlayerInfoJsonList[index].hp > 0) {
                for (let i = 0; i < IDAndPathJsonList.length; i++) {
                    if (IDAndPathJsonList[i].id == dataReceivedFromServer.id) {
                        IDAndPathJsonList[i].path.push([lat, lng]);
                        break;
                    }
                }
                jsonPathList.leftTeam[index].length > 1 && jsonPathList.leftTeam[index].shift() // 保持数组长度，避免过度push不断重新绘制之前的路径
                var pathTemp = jsonPathList.leftTeam[index];
                pathTemp.push([lat, lng]);
                jsonPathList.leftTeam[index] = pathTemp;
                var newLatlngPoint = L.latLng(lat, lng);
                leftPlayerInfoJsonList[index].hp > 0 && marker.setLatLng(newLatlngPoint);
                //处理收到的json消息，提取id与处理经纬度转成字符传给servlet接口
                var dataToSend = { "id": dataReceivedFromServer.id, "path": [lat, lng] };
                var jsonToString = JSON.stringify(dataToSend);
                start(jsonToString);
            }
        }
        //显示右锚点运动轨迹
        function rightTeamMarkerPathDisplay(marker, index) {
            marker.on('move', function (marker) { // 监听点位移动事件 move
                L.polyline(jsonPathList.rightTeam[index], { color: colorList[index], weight: 2 }).addTo(map) // 绘制线到地图图层
            })
        }

        //设置更新右队锚点(修改)
        function rightTeamSetRandomLatLng(markerList, dataReceived) {
            var rightLiList = document.querySelector(".rightPlayers").querySelectorAll("li");
            //array.slice(start, end) 截取字符串 1开始计数
            // var dataReceivedFromServer = JSON.parse(dataReceived);//接收后台传来的数据  假设传过来的直接是json字符串
            var dataReceivedFromServer = dataReceived;
            for (let j = 0; j < dataReceived.length; j++) {
                rightLiList.forEach(function (res) {
                    var id = res.getAttribute("data-id");
                    if (id == dataReceived[j].id) {
                        var index = res.getAttribute("data-index");//获取对应id的index位置值
                        rightMarkerMove(markerList[index], index, dataReceived[j]);
                        // rightTeamMarkerPathDisplay(markerList[index], index);
                    }
                })
            }
        }

        //右队锚点随机运动
        function rightMarkerMove(marker, index = 0, dataReceivedFromServer) {
            var gps = dataReceivedFromServer.coord.split('|');
            var lat = parseFloat(gps[0]);
            var lng = parseFloat(gps[1]);
            if (rightPlayerInfoJsonList[index].hp > 0) {
                for (let i = 0; i < IDAndPathJsonList.length; i++) {
                    if (IDAndPathJsonList[i].id == dataReceivedFromServer.id) {
                        IDAndPathJsonList[i].path.push([lat, lng]);
                        break;
                    }
                }
                jsonPathList.rightTeam[index].length > 1 && jsonPathList.rightTeam[index].shift() // 保持数组长度，避免过度push不断重新绘制之前的路径
                var pathTemp = jsonPathList.rightTeam[index];
                pathTemp.push([lat, lng]);
                jsonPathList.rightTeam[index] = pathTemp;
                var newLatlngPoint = L.latLng(lat, lng);
                rightPlayerInfoJsonList[index].hp > 0 && marker.setLatLng(newLatlngPoint);
                //处理收到的json消息，提取id与处理经纬度转成字符传给servlet接口
                var dataToSend = { "id": dataReceivedFromServer.id, "path": [lat, lng] };
                var jsonToString = JSON.stringify(dataToSend);
                start(jsonToString);
            }
        }

        //双击头像恢复HP
        function playersIconDoubleClickEvent(team) {
            var liList = document.querySelector(team).querySelectorAll("li");
            liList.forEach(function (res, index) {
                res.querySelector("img").addEventListener("dblclick", function () {
                    var ID = res.getAttribute("data-id");
                    show(ID);

                    // res.setAttribute("data-hp", 100);

                    // if (res.parentNode.getAttribute("class").includes("left")) {
                    //     res.style.backgroundColor = "#86ceea";
                    //     leftPlayerInfoJsonList[index].hp = 100;
                    // }
                    // else {
                    //     res.style.backgroundColor = "#ef9393";
                    //     rightPlayerInfoJsonList[index].hp = 100;

                    // }
                    // updatePlayersHpDisplay();
                    // CountPlayersSurvivorsNumber(".leftPlayers", ".blueTeamSurvivors");
                    // CountPlayersSurvivorsNumber(".rightPlayers", ".redTeamSurvivors");

                })
            })
        }

        function randomIntNum(min, max) {
            var randomNum = Math.random() * (max - min) + min;
            return parseInt(randomNum);
        }
        function randomGPS(min, max) {
            var randomNum = Math.random() * (max - min) + min;
            return parseFloat(randomNum.toFixed(6));
        }

        //模拟发送的数据(修改)
        function sendDate() {
            var date = [
                // { "id": "0", "coord": "113.123|24.369", "msg": 0 },
                // { "id": "1", "coord": "112.123|24.369", "msg": 0 },
                // { "id": "2", "coord": "111.123|24.369", "msg": 0 },
                // { "id": "3", "coord": "113.123|24.369", "msg": 0 },
                // { "id": "4", "coord": "113.123|24.369", "msg": 0 },
                // { "id": "5", "coord": "113.123|24.369", "msg": 0 },
                // { "id": "6", "coord": "113.123|24.369", "msg": 0 },
                // { "id": "7", "coord": "113.123|24.369", "msg": 0 },
                // { "id": "8", "coord": "113.123|24.369", "msg": 0 },
                // { "id": "9", "coord": "113.123|24.369", "msg": 0 },
                { "id": "121234", "coord": "113.123|24.369", "msg": 0 },
                { "id": "87654", "coord": "112.123|24.369", "msg": 0 },
                { "id": "334455", "coord": "111.123|24.369", "msg": 0 },
                { "id": "34563456", "coord": "113.123|24.369", "msg": 0 },
                { "id": "234532456", "coord": "113.123|24.369", "msg": 0 },
            ];
            tempList = []
            var index, lat, lng;
            for (let i = 0; i < 2; i++) {
                index = randomIntNum(0, 5);
                // console.log(index);

                lat = randomGPS(33.464671, 33.664671);
                lng = randomGPS(118.859960, 118.959960);
                // console.log(lat + '|' + lng);
                date[index].coord = lat + '|' + lng;
                tempList.push(date[index]);
            }
            return tempList;
        }
        //指令2
        //GETMEN命令获得所有人员基本数据并处理获得的数据
        function GETMENCommand() {
            bluePlayersIDList = [], redPlayersIDList = [];//用于存储ID  提升为全局变量
            $.ajax({
                url: "http://localhost:8090/servlet/ShootData",
                type: "GET",
                data: { funTypeName: "GETMEN" },
                dataType: "JSON",
                success: function (res) {
                    //需返回一个状态 status
                    //{"status":true/false,"data":{.....}}
                    if (res.status) {
                        //成功返回人员信息
                        var data = res.data;
                        data = data.split(";");
                        for (let i = 0; i < data.length; i++) {
                            data[i].length < 1 && data.splice(i)
                            if (data[i]) {
                                var json = {}
                                var str = data[i].split("|")
                                str.forEach(res => {
                                    var temp = [];
                                    temp = res.split("=");
                                    json[temp[0]] = temp[1];
                                })
                                data[i] = json;
                            }
                        }
                        console.log(data);
                        data.forEach(res => {//分队伍存储人员ID
                            res.name_attrib == "蓝队" && bluePlayersIDList.push(res.id_Flag);
                            res.name_attrib == "红队" && redPlayersIDList.push(res.id_Flag);
                        })
                    } else {

                    }
                },
                error: function () {
                    console.log("GETMEN错误");
                }
            })
        }
        //指令3
        //恢复人员HP至满状态(复活)
        //放到头像双击事件中
        function ResetPlayerStatus(ID) {
            var waitToResetHPsPlayer = document.querySelector('li[data-id=' + '"' + (ID) + '"' + ']')
            if (waitToResetHPsPlayer) {
                //将指定玩家HP恢复
                waitToResetHPsPlayer.setAttribute("data-hp", 100);
                waitToResetHPsPlayer.setAttribute("data-numberofrevive", parseInt(waitToResetHPsPlayer.getAttribute("data-numberofrevive")) + 1)

                if (waitToResetHPsPlayer.parentNode.getAttribute("class").includes("left")) {
                    waitToResetHPsPlayer.style.backgroundColor = "#86ceea";
                    leftPlayerInfoJsonList[waitToResetHPsPlayer.getAttribute("data-index")].hp = 100;
                }
                else {
                    waitToResetHPsPlayer.style.backgroundColor = "#ef9393";
                    rightPlayerInfoJsonList[waitToResetHPsPlayer.getAttribute("data-index")].hp = 100;
                }
            }

            // $.ajax({
            //     url: "http://localhost:8090/servlet/ShootData",
            //     type: "GET",
            //     data: {
            //         funTypeName: "RISE",
            //         id_Flag: ID,
            //     },
            //     dataType: "JSON",
            //     success: function (res) {
            //         if (res == "ok") {
            //             var waitToResetHPsPlayer = document.querySelector('li[data-id=' + '"' + (ID) + '"' + ']')
            //             if (waitToResetHPsPlayer) {
            //                 //将指定玩家HP恢复
            //                 waitToResetHPsPlayer.setAttribute("data-hp", 100);

            //                 if (waitToResetHPsPlayer.parentNode.getAttribute("class").includes("left")) {
            //                     waitToResetHPsPlayer.style.backgroundColor = "#86ceea";
            //                     leftPlayerInfoJsonList[waitToResetHPsPlayer.getAttribute("data-index")].hp = 100;
            //                 }
            //                 else {
            //                     waitToResetHPsPlayer.style.backgroundColor = "#ef9393";
            //                     rightPlayerInfoJsonList[waitToResetHPsPlayer.getAttribute("data-index")].hp = 100;
            //                 }
            //             }
            //             else {
            //                 return alert("无此ID");
            //             }
            //         }else{
            //             alert("更新失败");
            //         }
            //     },
            //     error: function (jqXHR, textStatus, errorThrown) {
            //         console.log(jqXHR.responseText);
            //         console.log(jqXHR.status);
            //         console.log(jqXHR.readyState);
            //         console.log(jqXHR.statusText);
            //         console.log(textStatus);
            //         console.log(errorThrown);
            //     }
            // })

        }
        //后台获取每个ID的状态并更新
        function sendAjaxs(IDList) {
            var index = 0;
            sendAjax();
            function sendAjax() {
                if (index >= IDList.length) {
                    return;
                }
                var liExist = document.querySelector('li[data-id=' + '"' + (IDList[index]) + '"' + ']');
                //指令1
                $.ajax({
                    url: "http://localhost:8090/servlet/ShootData",
                    type: "GET",
                    async: true,//异步
                    data: {
                        funTypeName: "LIVINGSTATE",
                        id_Flag: IDList[index],
                    },
                    dataType: "JSON",
                    success: function (res) {
                        var li = document.querySelector('li[data-id=' + '"' + (res.id_Flag) + '"' + ']');
                        li.setAttribute("data-hit_state", res.hit_state);
                        li.setAttribute("data-NumberOfRevive", res.cts_revive);
                        li.setAttribute("data-hp", res.blood_volume);
                        li.setAttribute("data-DamageDescription", res.disc_damage);
                        index++;
                        sendAjax();
                    },
                    error: function () {
                        console.log(IDList[index] + "ajax请求错误");
                    }
                })
            }
        }
        //获取比赛具体分钟数
        function getGameTime() {
            $.ajax({
                url: "http://localhost:8090/servlet/TeamManage?funTypeName=param&pname=gamelong&pvalue=",
                type: "GET",
                dataType: "JSON",
                success: function (response) {
                    if (response == "ok") {
                        if (response.data.includes("gamelong")) {
                            var num = res.data.slice(res.data.indexOf("=") + 1)
                            gameMinutes = parseInt(num);
                        } else {
                            console.log("data中gamelong不存在");
                        }
                    }
                },
                error: function () {
                    // gameMinutes=20;
                    console.log("比赛时长获取失败");
                }
            });

        }

        function onMessage(event) {
            console.log("服务器说：" + event.data);
        }
        function onOpen(event) {
            console.log("Connection established");

        }

        function onError(event) {
            console.log(event.data);
        }

        function start(data) {
            if (webSocket.readyState === 1) {

                webSocket.send(data);
                return false;
            }
        }
        function saveAsJson(str) {
            const blob = new Blob([str], { type: "application/json;charset=utf-8" });
            const href = URL.createObjectURL(blob);
            const alink = document.createElement("a");
            alink.style.display = "none";
            alink.download = "路径.json"; // 下载后文件名
            alink.href = href;
            document.body.appendChild(alink);
            alink.click();
            document.body.removeChild(alink); // 下载完成移除元素
            URL.revokeObjectURL(href); // 释放掉blob对象
        }
        function downLoad() {

            saveAsJson(JSON.stringify(IDAndPathJsonList))

        }
    </script>

    <title>Gaoded statellite Map</title>
</head>

<body>
    <div class="leftTeam">
        <button onclick="downLoad()">点击我下载文件</button>

        <button id="ajaxTest">test</button>

        <ul class="leftPlayers">

        </ul>
    </div>

    <div class="rightTeam">
        <ul class="rightPlayers">
        </ul>
    </div>

    <div class="battleFieldSituationInfo">

        <div class="blueTeam">
            <h3 style="writing-mode: vertical-lr;">蓝方</h3>
        </div>

        <div class="scoreAndTime">
            <div class="blueTeamSurvivors">4</div>
            <p class="timeCounter" id="countdown"></p>
            <div class="redTeamSurvivors">2</div>
        </div>
        <div class="redTeam">
            <h3 style="writing-mode: vertical-lr;">红方</h3>
        </div>

    </div>

    <div id='map'></div>
    <div class="container">
        <div class="modal">
            <div class="modal-header">
                <p class="title">提示</p>
                <p class="close">×</p>
            </div>
            <div id="modal-content">

            </div>
            <div class="modal-footer">
                <button id="confirmBtn" class="confirm btn">确认</button>

                <button class="close btn">取消</button>
            </div>
        </div>
        <div class="mask"></div>
    </div>


</body>

</html>